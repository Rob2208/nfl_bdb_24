---
title: "PEP: A metric for evaluating the importance of tackles"
author: "Robert Bajons, Jan-Ole Koslik, Rouven Michels, Marius Ötting"
date: "`r format(Sys.time(), '%d/%m/%y')`"
output: html_document
---

```{r setup, echo = FALSE, warning=FALSE, message=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(flextable)
library(ftExtra)
library(scales)
library(reactable)
library(reactablefmtr)
library(RCurl)
library(htmltools)
library(crosstalk)
library(ggridges)

pbp_data_bdb <- read.csv("data/plays.csv") %>% 
  mutate(uId = paste(gameId,playId,sep = "_"))

tackle_list <- readRDS("data/tackles_info_data_full_oos.rds")

tackles <- tackle_list[[1]]
tackle_info_real2 <- tackle_list[[2]]
tackle_info_simple2 <- tackle_list[[3]]
tackle_pred_real <- tackle_list[[4]]
tackle_pred_s <- tackle_list[[5]]
tackle_vals <- tackle_list[[6]] 
best_tacklers <- tackle_list[[7]]

```

> "Football is two things. It's blocking and tackling."

> *Vince Lombardi*

## Introduction

Although this citation dates back several decades --- and the sport of American Football has of course changed since then --- tackling remains an integral aspect of the game. In contrast to decision-making scenarios faced by players, such as a quarterback's selection of a target for a pass, the decision for a tackle is more straightforward: a defense player should always promptly tackle the ball carrier.

When assessing players' tackles, one is usually interested in a hypothetical scenario: the potential outcome if a player were to miss a tackle. 
Essentially, this involves quantifying the yards saved by a defensive player. Ideally, albeit impractically, running a play twice --- once with the defense player executing the tackle and a second time without --- would allow a direct comparison of the yardage gained by the ball carrier, thus enabling to evaluate the impact of the defensive player's tackle.

Given the impracticability of such a hypothetical scenario, our approach involves approximating it by predicting the yardline of the ongoing play twice. First, we consider the inclusion of the closest defender who executed the tackle, and in a next step, we exclude this player. However, only quantifying the yards saved by a particular tackle does not suffice as an adequate measure of tackle value, due to lack of interpretability on a scale truely relevant to the game outcome. Therefore, we aim to produce a measure of tackle value on the scale of expected points (EP). EP can be viewed as a complicated mapping of the end of play yardline to the expected points in the next play. A sole point prediction of the mean yard line misses uncertainty propagation to the EP scale, such that we aim to produce a full conditional density estimate to calculate the expected points from. The metric derived from this methodology then quantifies the *prevented expected points (PEP)*.

<!-- We will find that such density estimates often show multimodality, which is especially relevant when large yards gained have a strong effect on the expected points. -->

<!-- Based on these predicted yardlines, we compute the expected points (EP) gained through the tackle. This approach enables us to evaluate players in terms of the importance of their tacklings. -->


## Data

To accurately predict the yardline at the end of any given play it is necessary to create several features derived from the tracking data. More specifically, we conducted the following feature preprocessing:

#### Change of coordinate system
We transformed the coordinate system by 

* redefining the x-variable as the x-distance to the endzone (such that all play directions are from right to left and the relevant endzone is at zero),
* centering the y-variable such that the center of the field is at zero,
* changing the direction variable, such that zero degrees represents heading straight towards the relevant endzone.

#### Response variable: Yards to be gained
For each play, we define the x-position of the ball carrier in the last frame as the end-of-play yard line. The response variable we aim to predict is now *yards to be gained* as the difference of the x-position of the ballcarrier in a given frame to the end-of-play yard line.

#### Feature engineering
For all players and the ball carrier we use the features already contained in the tracking data, namely x- and y-coordinates, speed, acceleration, distance covered, orientation and direction.

For all players except the ball carrier we further compute the

* euclidean distance to the ball carrier,
* x-distance to the ball carrier,
* y-distance to the ball carrier.

For defensive players only, we additionally compute the absolute difference of the defender's direction and the angle of the shortest segement between the defender and the ball carrier.

Subsequently, we order all players (in each frame) with respect to their euclidean distance to the ball carrier and standardize all features.

For the identification of tackle events, we do not rely on the event column. Instead, we define as the tackle event the frame in which the tacklers distance to the ballcarrier is minimal within a given play. <span style="color: red;">Hier müssen wir noch schreiben, dass wir die Spieler vorher aus dem Tackle Event Datensatz haben, oder?</span>

<span style="color: red;">Schreiben welche plays wir rausgenommen haben und warum. Ja, würde ich kurz</span>

<span style="color: red;">...add an example play to illustrate the "what if" scenario...
Hier die end of play yardline und "yards to be gained" einzeichnen.</span>

<span style="color: red;">Animation</span>

## Analysis

Our analysis comprises four steps:

#### 1. Model Training
<span style="color: red;">We train a model designed to predict the yards to be gained which can be backtransformed into a prediction for the end-of-play yardline </span>(see Yurko et al., 2020). The model uses the previously described features, only including the ten closest defenders. <span style="color: red;">While accounting for the time-series nature of the data by using, for example, a transformer architecture could be beneficial, we do not only want to obtain a point estimate for the yard line at the end of the play.</span> Moreover, we aim to account for potential non-linear and interaction effects. Then, to end up with a conditional density estimator $\hat{f}(y \mid x)$, we consider a random forest comprising 1000 individual trees, <span style="color: red;">treating some accuracy in mean prediction for adequate uncertainty quantification.</span> In general, modeling the uncertainty is important, as for example, in high-yardage plays, the variance of the end of play yardline is considerably larger, than in low-yardage plays.

<span style="color: red;">Plot prediction für low und high yardage plays, der zeigt, dass unsere Verteilung recht schmal und recht breit sein kann.</span>

<span style="color: red;">RMSE und MAE reporten.</span>

#### 2. Tackler Replacement Procedure 
For each tackle, we systematically remove the closest defender at the moment of the tackle and replace the features with those of the second closest defender. Further on, we replace the second closest with the third closest, and so on. In this way, we come up with a prediction for a hypothetical "what if the tackle would be missed" scenario which then can be compared to the real existing tackle.

#### 3. Yardline Prediction 
Using the trained random forest, we predict the end-of-play yardline with 1000 trees. Using a kernel density estimator for visualization, we can plot the dynamically evolving conditional density estimation withing any given play.

```{r animation, fig.show='animate', ffmpeg.format='gif', dev='jpeg', echo = FALSE,fig.width= 8,fig.height=8}
library(scales)

coldens = "chartreuse1"
collos = "purple"
coleop = "darkgreen"
coloff = "blue"
coldef = "red"

ex_play <- readRDS("data/example_play_for_anim3.rds")
gpId <- ex_play[[1]]
tracking_play <- ex_play[[2]]
play_train <- ex_play[[3]]
pred <- ex_play[[4]]
pbp_info <- ex_play[[5]]


par(mfrow = c(2,1), oma = c(5,4,0,0) + 0.1, mar = c(0, 0, 0, 2) + 0.1)
for(i in 1:(nrow(pred)-7)){
  plot(tracking_play$x_bc[i], tracking_play$y_bc[i], pch = 1, lwd = 6, col = coloff, 
       xlim = c(0,min(round(max(tracking_play$x_bc),-1)+30,100)), ylim = c(-53.3/2, 53.3/2), 
       xlab = "", ylab = "", bty = "n",xaxt = "n", yaxt = "n")
  segments(x0 = 1:20 *5,
           y0 = 53.3/2,
           x1 = 1:20 *5,
           y1 = -53.3/2,
           col = "lightgray", lwd = 0.5)
  segments(x0 = c(0,0),
           y0 = c(53.3/2,-53.3/2),
           x1 = c(100,100),
           y1 = c(53.3/2,-53.3/2),
           lwd = 1.5)
  
  segments(x0 = pbp_info$yardline_100,
           y0 = 53.3/2,
           x1 = pbp_info$yardline_100,
           y1 = -53.3/2,
           col = collos,lty = 2)
  #abline(v = tackle_info$yardline_100, col = collos,lty = 2) # line of scrimmage
  
  segments(x0 = 0,
           y0 = 53.3/2,
           x1 = 0,
           y1 = -53.3/2,
           lwd = 1.5)
  #abline(v = 0, lwd = 1.5) # endzone
  
  segments(x0 = pbp_info$true_yardline,
           y0 = 53.3/2,
           x1 = pbp_info$true_yardline,
           y1 = -53.3/2,
           col = coleop,lty = 2)
  
  # plot predicted yard end yard line
  for(j in 1:1000){
    segments(x0 = max(tracking_play$x_bc[i]-pred[i,j],0),
             y0 = 53.3/2,
             x1 = max(tracking_play$x_bc[i]-pred[i,j],0),
             y1 = -53.3/2,
             lwd = 2, col = alpha(coldens, 0.01))
    #abline(v = tackle_frame$x_bc-pred_r[j], lwd = 2, col = alpha(coldens, 0.01))
  }
  segments(x0 = max(tracking_play$x_bc[i] - mean(pred[i,]),0),
           y0 = 53.3/2,
           x1 = max(tracking_play$x_bc[i] - mean(pred[i,]),0),
           y1 = -53.3/2,
           col = 1, lwd = 2)
  #abline(v = tackle_frame$x_bc - mean(pred_r), col = 1, lwd = 2) # expected eop yardline
  segments(x0 = max(tracking_play$x_bc[i] - mean(pred[i,]),0),
           y0 = 53.3/2,
           x1 = max(tracking_play$x_bc[i] - mean(pred[i,]),0),
           y1 = -53.3/2,
           col = coldens, lwd = 1)
  #abline(v = tackle_frame$x_bc - mean(pred_r), col = coldens, lwd = 1) # expected eop yardline
  
  points(tracking_play$x_bc[i], tracking_play$y_bc[i], pch = 1, lwd = 6, col = coloff)
  points(tracking_play$x_bc[i], tracking_play$y_bc[i], pch = 16, col = coloff)
  
  for(j in 2:11){
    points(tracking_play[i,paste0("x_or_off", j)], tracking_play[i, paste0("y_or_off", j)], pch = 20, col = coloff)
  }
  for(j in 1:11){
    points(tracking_play[i,paste0("x_or_def", j)], tracking_play[i, paste0("y_or_def", j)], pch = 20, col = coldef)
  }
  points(tracking_play$x_football[i], tracking_play$y_football[i], pch = 9, col = "coral1", lwd = 2)
  legend(x = pbp_info$yardline_100-10, y = -16,
         legend = c("Off","Def","Football","LOS","EOP"),
         col = c(coloff,coldef,"coral1",collos,coleop),
         pch = c(20,20,9,NA,NA), lty = c(NA,NA,NA,2,2),
         cex = 0.7, ncol = 2,bg = "white") 
  
  plot(density(pmax(tracking_play$x_bc[i]-pred[i,],0), bw = 2.5,from = 0), 
       col = coldens, lwd = 2, xlim = c(0,min(round(max(tracking_play$x_bc),-1)+30,100)), bty = "n", main = "", xlab = "eop yardline")
  abline(v = 1:20 *5, col = "lightgray", lwd = 0.5)
  abline(v = pbp_info$yardline_100, col = collos,lty = 2)
  abline(v = 0, lwd = 1.5) # endzone
  abline(v = max(tracking_play$x_bc[i] - mean(pred[i,]),0), col = 1, lwd = 2)
  abline(v = max(tracking_play$x_bc[i] - mean(pred[i,]),0), col = coldens, lwd = 1)
  abline(v = pbp_info$true_yardline, col = coleop,lty = 2)
  
  #Sys.sleep(0.1)
}

```

For the tackle frames in particular, we obtain one predictive density, based on the original features, and one based on the replacement procedure explained above.

```{r plot_new1, fig.height=10, fig.width= 12, echo = FALSE}

ex_play_r_vs_h <- readRDS("data/ex_play_vis_r_vs_h.rds")

tackle_frame <- ex_play_r_vs_h[[1]]
tackle_info <- ex_play_r_vs_h[[2]]
pred_r <- ex_play_r_vs_h[[3]]
pred_s <- ex_play_r_vs_h[[4]]

vis_tackle_plays3 <- function(gpId,
                              coldens = "chartreuse1",
                              collos = "purple",
                              coleop = "darkgreen",
                              coloff = "blue",
                              coldef = "red"){
  
  par(mfrow = c(2,2), oma = c(5,4,0,0) + 0.1, mar = c(0, 0, 0, 2) + 0.1)
  
  ########################
  ### plot fields, first real, then hyp
  
  plot(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = coloff, 
       xlim = c(0,min(round(max(tackle_frame$x_bc),-1)+30,100)), ylim = c(-53.3/2, 53.3/2+5), 
       xlab = "", ylab = "", bty = "n",xaxt = "n", yaxt = "n")
  text(x=min(round(max(tackle_frame$x_bc),-1)+30,100)/2, y=53.3/2+2.5, "Real tackle frame", cex=1.5,font = 2) 
  segments(x0 = 1:20 *5,
           y0 = 53.3/2,
           x1 = 1:20 *5,
           y1 = -53.3/2,
           col = "lightgray", lwd = 0.5)
  segments(x0 = c(0,0),
           y0 = c(53.3/2,-53.3/2),
           x1 = c(100,100),
           y1 = c(53.3/2,-53.3/2),
           lwd = 1.5)
  
  segments(x0 = tackle_info$yardline_100,
           y0 = 53.3/2,
           x1 = tackle_info$yardline_100,
           y1 = -53.3/2,
           col = collos,lty = 2)
  #abline(v = tackle_info$yardline_100, col = "purple",lty = 2) # line of scrimmage
  
  segments(x0 = 0,
           y0 = 53.3/2,
           x1 = 0,
           y1 = -53.3/2,
           lwd = 1.5)
  #abline(v = 0, lwd = 1.5) # endzone
  
  segments(x0 = tackle_info$true_yardline,
           y0 = 53.3/2,
           x1 = tackle_info$true_yardline,
           y1 = -53.3/2,
           col = coleop,lty = 2)
  
  # plot predicted yard end yard line
  for(j in 1:1000){
    segments(x0 = max(tackle_frame$x_bc-pred_r[j],0),
             y0 = 53.3/2,
             x1 = max(tackle_frame$x_bc-pred_r[j],0),
             y1 = -53.3/2,
             lwd = 2, col = alpha(coldens, 0.01))
    #abline(v = tackle_frame$x_bc-pred_r[j], lwd = 2, col = alpha(coldens, 0.01))
  }
  segments(x0 = max(tackle_frame$x_bc - mean(pred_r),0),
           y0 = 53.3/2,
           x1 = max(tackle_frame$x_bc - mean(pred_r),0),
           y1 = -53.3/2,
           col = 1, lwd = 2)
  #abline(v = tackle_frame$x_bc - mean(pred_r), col = 1, lwd = 2) # expected eop yardline
  segments(x0 = max(tackle_frame$x_bc - mean(pred_r),0),
           y0 = 53.3/2,
           x1 = max(tackle_frame$x_bc - mean(pred_r),0),
           y1 = -53.3/2,
           col = coldens, lwd = 1)
  #abline(v = tackle_frame$x_bc - mean(pred_r), col = coldens, lwd = 1) # expected eop yardline
  
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = coloff)
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 16, col = coloff)
  
  for(j in 2:11){
    points(tackle_frame[,paste0("x_or_off", j)], tackle_frame[, paste0("y_or_off", j)], pch = 20, col = coloff)
  }
  for(j in 2:11){
    points(tackle_frame[,paste0("x_or_def", j)], tackle_frame[, paste0("y_or_def", j)], pch = 20, col = coldef)
  }
  points(tackle_frame[,paste0("x_or_def", 1)], tackle_frame[, paste0("y_or_def", 1)], pch = 6, lwd = 3, col = coldef)
  #points(trackingsub$x_football[i], trackingsub$y_football[i], pch = 9, col = "coral1", lwd = 2)
  
  ### hypothetical frame
  
  plot(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = coloff, 
       xlim = c(0,min(round(max(tackle_frame$x_bc),-1)+30,100)), ylim = c(-53.3/2, 53.3/2+5), 
       xlab = "", ylab = "", bty = "n",xaxt = "n", yaxt = "n")
  text(x=min(round(max(tackle_frame$x_bc),-1)+30,100)/2, y=53.3/2+2.5, "Hypothetical tackle frame", cex=1.5,font = 2) 
  segments(x0 = 1:20 *5,
           y0 = 53.3/2,
           x1 = 1:20 *5,
           y1 = -53.3/2,
           col = "lightgray", lwd = 0.5)
  segments(x0 = c(0,0),
           y0 = c(53.3/2,-53.3/2),
           x1 = c(100,100),
           y1 = c(53.3/2,-53.3/2),
           lwd = 1.5)
  
  segments(x0 = tackle_info$yardline_100,
           y0 = 53.3/2,
           x1 = tackle_info$yardline_100,
           y1 = -53.3/2,
           col = collos,lty = 2)
  #abline(v = tackle_info$yardline_100, col = collos,lty = 2) # line of scrimmage
  
  segments(x0 = 0,
           y0 = 53.3/2,
           x1 = 0,
           y1 = -53.3/2,
           lwd = 1.5)
  #abline(v = 0, lwd = 1.5) # endzone
  
  segments(x0 = tackle_info$true_yardline,
           y0 = 53.3/2,
           x1 = tackle_info$true_yardline,
           y1 = -53.3/2,
           col = coleop,lty = 2)
  
  # plot predicted yard end yard line
  for(j in 1:1000){
    segments(x0 = max(tackle_frame$x_bc-pred_s[j],0),
             y0 = 53.3/2,
             x1 = max(tackle_frame$x_bc-pred_s[j],0),
             y1 = -53.3/2,
             lwd = 2, col = alpha(coldens, 0.01))
    #abline(v = tackle_frame$x_bc-pred_s[j], lwd = 2, col = alpha(coldens, 0.01))
  }
  segments(x0 = max(tackle_frame$x_bc - mean(pred_s),0),
           y0 = 53.3/2,
           x1 = max(tackle_frame$x_bc - mean(pred_s),0),
           y1 = -53.3/2,
           col = 1, lwd = 2)
  #abline(v = tackle_frame$x_bc - mean(pred_s), col = 1, lwd = 2) # expected eop yardline
  segments(x0 = max(tackle_frame$x_bc - mean(pred_s),0),
           y0 = 53.3/2,
           x1 = max(tackle_frame$x_bc - mean(pred_s),0),
           y1 = -53.3/2,
           col = coldens, lwd = 1)
  #abline(v = tackle_frame$x_bc - mean(pred_s), col = coldens, lwd = 1) # expected eop yardline
  
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = coloff)
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 16, col = coloff)
  
  for(j in 2:11){
    points(tackle_frame[,paste0("x_or_off", j)], tackle_frame[, paste0("y_or_off", j)], pch = 20, col = coloff)
  }
  for(j in 1:10){
    points(tackle_frame[,paste0("x_or_def", j+1)], tackle_frame[, paste0("y_or_def", j+1)], pch = 20, col = coldef)
  }
  #points(trackingsub$x_football[i], trackingsub$y_football[i], pch = 9, col = "coral1", lwd = 2)
  
  ########################
  ### density lines: first real, then hypothetical
  
  plot(density(pmax(tackle_frame$x_bc-pred_r,0), bw = 2.5,from = 0), 
       col = coldens, lwd = 2, xlim = c(0,min(round(max(tackle_frame$x_bc),-1)+30,100)), bty = "n", main = "", xlab = "eop yardline")
  abline(v = 1:20 *5, col = "lightgray", lwd = 0.5)
  abline(v = tackle_info$yardline_100, col = collos,lty = 2)
  abline(v = 0, lwd = 1.5) # endzone
  abline(v = tackle_frame$x_bc - mean(pred_r), col = 1, lwd = 2)
  abline(v = tackle_frame$x_bc - mean(pred_r), col = coldens, lwd = 1)
  abline(v = tackle_info$true_yardline, col = coleop,lty = 2)
  
  
  
  
  plot(density(pmax(tackle_frame$x_bc-pred_s,0), bw = 2.5,from = 0), 
       col = coldens, lwd = 2, xlim = c(0,min(round(max(tackle_frame$x_bc),-1)+30,100)), bty = "n", main = "", xlab = "eop yardline")
  abline(v = 1:20 *5, col = "lightgray", lwd = 0.5)
  abline(v = tackle_info$yardline_100, col = collos,lty = 2)
  abline(v = 0, lwd = 1.5) # endzone
  abline(v = tackle_frame$x_bc - mean(pred_s), col = 1, lwd = 2)
  abline(v = tackle_frame$x_bc - mean(pred_s), col = coldens, lwd = 1)
  abline(v = tackle_info$true_yardline, col = coleop,lty = 2)
  
}

gpId <- 2022103003480

vis_tackle_plays3(gpId)

```

#### 4. Tackle Evaluation 
<!-- We set up an own EP model (similar to nflfastR, ...) and calculate the EPs for all 1000 predictions and average the outcomes (because of integral calculations, Monte Carlo approximation).  -->
<!-- Es gibt zwei Möglichkeiten (echte + expected mit full player) einen Tackle Value zu berechnen, wir nehmen Möglichkeit 2  -->
<!-- This process yields the tackle's value *PEP* (for prevented Expected Points) with the respective tackler excluded from the data set.  -->

<!-- Causal inference Ansatz, aber auf g(y) also EP Ebene. -->
From a mathematical perspective, we want to obtain the mean expected points, given the conditional distribution of the end of play yardline produced by our random forest. More formally, letting the mapping $g$ represent the calculation of expected points based on the end of play yardline $y$ we are interested in

$$
\text{E}(g(y) \mid x) = \int_{0}^\infty g(y) \: \hat{f} (y \mid x) \: dy
$$
For the mapping $g$ we set up our own EP model based on an XGBoost architecture (Chen and Guestrin, 2016) which, after model training, can be used to calculate the expected points. In essence, we follow the implementation of the EP model from the nflfastR package (Carl and Baldwin, 2023). However, we have to derive all features used in the model solely from the predicted yards to be gained of each play. This makes the use of the model from the nflfastR package impractical. As features for our model we use the yard line of the play (adjusted LOS), yards to go, down, quarter, a home team indicator and timeouts remaining for each team (we omit features such as half seconds remaining, which are not extractable from the predicted yards to be gained).  <span style="color: red;">Wenn gewünscht kann ich noch Model comparisons (MAE oder so) vom unserem Modell zum Modell von nflfastR angeben. Um zu zeigen, dass unser Modell ähnlich gut funktioniert. RM: Ich glaube sowas ist gut für den Appendix.</span>    

Instead of a two-step procedure, first obtaining a kernel density estimate from the individual tree predictions (introducing subjectivity in bandwidth choice) and then integrating numerically, we treat the tree-predictions $\hat{y}_1, \dots, \hat{y}_{1000}$ as samples from the conditional density and approximate the above expectation via the Monte Carlo estimate
$$
\frac{1}{1000} \sum_{i=1}^{1000} g(\hat{y}_i).
$$

A metric for quantifying tackle value can now be obtained in two ways. Either, the hypothetical expected points can be compared to the mean expected points based on predicted conditional density using the original features, i.e.
$$
\text{E}(g(y) \mid x_0) - \text{E}(g(y) \mid x_1),
$$
where $x_0$ denotes the transformed features after removing the closest defender and $x_1$ denotes the original features. This metric can be considered the treatment effect of the tackle. 

<span style="color: orange;">But we can also replace the second term by the expected points pased on the true observed end of play yard line, yielding a value of that specific tackle.</span>

![](plots/PEP_pipeline.jpg)

## Player evaluation

```{r players, echo = FALSE, warning=FALSE, message=FALSE}

make_pal <- function(value,col_low = "darkred",col_high = "darkgreen",nq = 10){
  colourer <- col_quantile(
    palette = c(col_low,col_high),
    domain = c(min(value), max(value)),
    n = nq)
  rev(names(table(colourer(value))))
}

data <- best_tacklers %>% select(displayName,club,url,position,n_tackles,
                           sum_tackle_gains,sum_tackle_gains2,
                           avg_per_tackle,avg_per_tackle2)

crosstalk_data <- SharedData$new(data)

#url.logo <- getURL("https://raw.githubusercontent.com/statsbylopez/BlogPosts/master/nfl_teamlogos.csv")
#df.logos <- read.csv(text = url.logo)

#best_tacklers <- best_tacklers %>%
#  left_join(df.logos , by = c("club" = "team_code"))


position_filter <- filter_checkbox(
  id = "pos",
  label = "Position",
  sharedData = crosstalk_data,
  group = ~ position,
  inline = TRUE
)

n_tackles_filter <- filter_slider(
  id = "n_tackles",
  label = "Number of tackles",
  sharedData = crosstalk_data,
  column = ~ n_tackles,
  ticks = TRUE,
  dragRange = FALSE,
  step = 1,
  width = "50%"
)

tbl <- reactable(crosstalk_data,
  bordered = TRUE,
  defaultSorted = "sum_tackle_gains2",
  defaultSortOrder = "desc",
  
  columns = list(
    displayName = colDef(
      name = "Name"
    ),
    club = colDef(
      name = "Team"
    ),
    url = colDef(
      name = "Team Logo",
      maxWidth = 70,
      align = "center",
      cell = embed_img(height = 25, width = 40)
    ),
    position = colDef(
      name = "Position"
    ),
    n_tackles = colDef(
      name = "# Tackles",
      maxWidth = 50
    ),
    sum_tackle_gains = colDef(
      name = "PEP (version 1)",
      format = colFormat(digits = 2),
      style = color_scales(best_tacklers, colors = make_pal(best_tacklers$sum_tackle_gains)),
      maxWidth = 70
    ),
    sum_tackle_gains2 = colDef(
      name = "PEP (version 2)",
      format = colFormat(digits = 2),
      style = color_scales(best_tacklers, colors = make_pal(best_tacklers$sum_tackle_gains2)),
      maxWidth = 70
    ),
    avg_per_tackle = colDef(
      name = "Avg PEP(v1)/Tackle",
      format = colFormat(digits = 2),
      style = color_scales(best_tacklers, colors = make_pal(best_tacklers$avg_per_tackle)),
      maxWidth = 70
    ),
    avg_per_tackle2 = colDef(
      name = "Avg PEP(v2)/Tackle",
      format = colFormat(digits = 2),
      style = color_scales(best_tacklers, colors = make_pal(best_tacklers$avg_per_tackle2)),
      maxWidth = 70
    )
  )
  
)

div(bscols(
  widths = c(4, NA),
    list(position_filter,
         n_tackles_filter))
)

### display table
div(tbl)

```

```{r pos, fig.height=8, fig.width= 6, echo = FALSE, warning=FALSE, message=FALSE}

pos_df <- best_tacklers %>% 
  group_by(position) %>% 
  summarise(avg = mean(sum_tackle_gains),
            avg2 = mean(sum_tackle_gains2),
            avg_n_tackles = mean(n_tackles),
            n_players = n()) %>% 
  arrange(desc(avg2)) %>% 
  filter(position != "DB" )

myorder <- pos_df %>% pull(position)

best_tacklers_plot <- best_tacklers %>%
  filter(position != "DB") %>%
  mutate(position = factor(position, levels = rev(myorder)))

colourer <- col_quantile(
  palette = c("darkred","darkgreen"),
  domain = c(min(pos_df$avg2), max(pos_df$avg2)),
  n = 10)

ggplot(
  best_tacklers_plot, 
  aes(x = sum_tackle_gains2, y = position,fill = position)
) +
  scale_fill_manual(values = alpha(rev(c("#006400", "#2B5F00", "#2B5F00", "#3F5900", "#4E5300", "#703B00", "#8B0000", "#8B0000", "#8B0000"))),0.2) +
  stat_density_ridges(quantile_lines=TRUE,
                      quantile_fun=function(x,...)c(mean(x)))+
  theme(legend.position = "none")+
  xlab("PEP")+
  labs(title = 'Distribution of sum of PEP (version 2) values per position')

```

- Tabelle
- PEP distribution by position

## Discussion
In this contribution, we developed a metric "PEP" for quantifying the value of a tackle. It allows practitioners to assess players, particularly in terms of their tackling abilities. 
However, there are a few drawbacks that need to be taken into account during the evaluation process. Important considerations are the position and the defensive playing styles of teams. Cornerbacks and safeties are often more capable of making "touchdown-saving tackles", resulting in their values typically being higher. Furthermore, safeties who engage in riskier defensive strategies, such as those employed by Brian Flores, receive less support of their teammates in the backfield, which is why their metrics may be higher. 
When taking such aspects into account, however, the metric we have developed can serve as an additional puzzle piece in the overall assessment of (defensive) players and might gain practical relevance in the process of scouting players and opponents.

## Code

All code for data preprocessing, model training, prediction and player evaluation can be found [here](https://github.com/Rob2208/nfl_bdb_24).

## References

* Carl S, Baldwin B (2023). nflfastR: Functions to Efficiently Access NFL Play by Play Data. R package version 4.6.0.9000, https://github.com/nflverse/nflfastR, https://www.nflfastr.com/.
* Chen, T., & Guestrin, C. (2016). XGBoost: A scalable tree boosting system. In Proceedings of the 22nd acm sigkdd international conference on knowledge discovery and data mining (pp. 785-794).
* Yurko, R., Matano, F., Richardson, L. F., Granered, N., Pospisil, T., Pelechrinis, K., & Ventura, S. L. (2020). Going deep: models for continuous-time within-play valuation of game outcomes in American football with tracking data. Journal of Quantitative Analysis in Sports, 16(2), 163-182.

