---
title: "Results and Analyses"
date: "`r format(Sys.time(), '%d/%m/%y')`"
output: html_document
---

```{r setup, echo = FALSE, warning=FALSE, message=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(flextable)
library(ftExtra)
library(scales)
library(reactable)
library(reactablefmtr)
library(RCurl)
library(htmltools)
library(crosstalk)
library(plotrix)

pbp_data_bdb <- read.csv("../data/nfl-big-data-bowl-2024/plays.csv") %>% 
  mutate(uId = paste(gameId,playId,sep = "_"))

tackle_list <- readRDS("../data/tackles_info_data_trw1-3.rds")

tackles <- tackle_list[[1]]
tackle_info_real2 <- tackle_list[[2]]
tackle_info_simple2 <- tackle_list[[3]]
tackle_pred_real <- tackle_list[[4]]
tackle_pred_s <- tackle_list[[5]]
tackle_vals <- tackle_list[[6]] 
best_tacklers <- tackle_list[[7]]

vis_tackle_plays <- function(gpId){
  tackle_frame <- tackles %>% filter(gameplayId == gpId)
  tackle_info <- tackle_info_real2 %>% filter(gameplayId == gpId)
  pred_r <- tackle_pred_real[which(tackle_info_real2$gameplayId == gpId),]
  pred_s <- tackle_pred_s[which(tackle_info_simple2$gameplayId == gpId),]
  
  par(mfrow = c(2,2), mar = c(4, 4, 0.5, 2) + 0.1)
  
  ########################
  ### real play and pred
  
  plot(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = "blue", xlim = c(0,min(round(max(tackle_frame$x_bc),-1)+30,100)), ylim = c(-53.3/2, 53.3/2), xlab = "x", ylab = "y")
  abline(v = 1:20 *5, col = "lightgray", lwd = 0.5)
  
  abline(v = tackle_info$yardline_100, col = "purple",lty = 2) # line of scrimmage
  abline(v = 0, lwd = 1.5) # endzone
  abline(v = tackle_info$true_yardline, col = "darkgreen",lty = 2) # true eop yardline
  
  # plot predicted yard end yard line
  for(j in 1:1000){
    abline(v = tackle_frame$x_bc-pred_r[j], lwd = 2, col = alpha("chartreuse1", 0.01))
  }
  abline(v = tackle_frame$x_bc - mean(pred_r), col = 1, lwd = 2) # expected eop yardline
  abline(v = tackle_frame$x_bc - mean(pred_r), col = "chartreuse1", lwd = 1) # expected eop yardline
  
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = "blue")
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 16, col = "blue")
  
  for(j in 2:11){
    points(tackle_frame[,paste0("x_or_off", j)], tackle_frame[, paste0("y_or_off", j)], pch = 20, col = "blue")
  }
  for(j in 1:10){
    points(tackle_frame[,paste0("x_or_def", j)], tackle_frame[, paste0("y_or_def", j)], pch = 20, col = "red")
  }
  #points(trackingsub$x_football[i], trackingsub$y_football[i], pch = 9, col = "coral1", lwd = 2)
  
  plot(density(tackle_frame$x_bc-pred_r, bw = 2.5), col = "chartreuse1", lwd = 2, xlim = c(0,min(round(max(tackle_frame$x_bc),-1)+30,100)), bty = "n", main = "", xlab = "eop yardline")
  abline(v = 1:20 *5, col = "lightgray", lwd = 0.5)
  abline(v = tackle_frame$x_bc - mean(pred_r), col = 1, lwd = 2)
  abline(v = tackle_frame$x_bc - mean(pred_r), col = "chartreuse1", lwd = 1)
  abline(v = tackle_info$true_yardline, col = "darkgreen",lty = 2)
  
  ########################
  ### hypothetical play and pred (without closest def)
  
  plot(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = "blue", xlim = c(0,min(round(max(tackle_frame$x_bc),-1)+30,100)), ylim = c(-53.3/2, 53.3/2), xlab = "x", ylab = "y")
  abline(v = 1:20 *5, col = "lightgray", lwd = 0.5)
  
  abline(v = tackle_info$yardline_100, col = "purple",lty = 2) # line of scrimmage
  abline(v = 0, lwd = 1.5) # endzone
  abline(v = tackle_info$true_yardline, col = "darkgreen",lty = 2) # true eop yardline
  
  # plot predicted yard end yard line
  for(j in 1:1000){
    abline(v = tackle_frame$x_bc-pred_s[j], lwd = 2, col = alpha("chartreuse1", 0.01))
  }
  abline(v = tackle_frame$x_bc - mean(pred_s), col = 1, lwd = 2) # expected eop yardline
  abline(v = tackle_frame$x_bc - mean(pred_s), col = "chartreuse1", lwd = 1) # expected eop yardline
  
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = "blue")
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 16, col = "blue")
  
  for(j in 2:11){
    points(tackle_frame[,paste0("x_or_off", j)], tackle_frame[, paste0("y_or_off", j)], pch = 20, col = "blue")
  }
  for(j in 1:10){
    points(tackle_frame[,paste0("x_or_def", j+1)], tackle_frame[, paste0("y_or_def", j+1)], pch = 20, col = "red")
  }
  #points(trackingsub$x_football[i], trackingsub$y_football[i], pch = 9, col = "coral1", lwd = 2)
  
  plot(density(tackle_frame$x_bc-pred_s, bw = 2.5), col = "chartreuse1", lwd = 2, xlim = c(0,min(round(max(tackle_frame$x_bc),-1)+30,100)), bty = "n", main = "", xlab = "eop yardline")
  abline(v = 1:20 *5, col = "lightgray", lwd = 0.5)
  abline(v = tackle_frame$x_bc - mean(pred_s), col = 1, lwd = 2)
  abline(v = tackle_frame$x_bc - mean(pred_s), col = "chartreuse1", lwd = 1)
  abline(v = tackle_info$true_yardline, col = "darkgreen",lty = 2)
  
}


```


## Tables of tackle values {.tabset}

### Real tackle frame (Def 1-10)

```{r real_tackle, echo = FALSE}

rt_tbl <- reactable(tackle_info_real2 %>% 
                      select(-gameplayId,-uId),
                    bordered = TRUE,
                    
                    columns = list(
                      `ep_tackle_def1-10` = colDef(
                        name = "EP Tackle",
                        format = colFormat(digits = 3), 
                      ),
                      avg_yg = colDef(
                        name = "AVG Yards Gained",
                        format = colFormat(digits = 3), 
                      ),
                      tackle_yardline = colDef(
                        name = "Tackle Yardline",
                        format = colFormat(digits = 2), 
                      ),
                      yardline_pred = colDef(
                        name = "Predicted Yardline (from avg)",
                        format = colFormat(digits = 2), 
                      ),
                      yardline_100 = colDef(
                        name = "Line of scrimmage (yardline from endzone)", 
                      ),
                      playResult = colDef(
                        name = "Real Yards Gained (from pbp)"
                      ),
                      true_yardline = colDef(
                        name = "Real EOP yardline (from pbp)" 
                      )
                    )
)

rt_tbl

```

### Hypothetical tackle frame (Def 2-11)

```{r hypo_tackle, echo = FALSE}

ht_tbl <- reactable(tackle_info_simple2 %>% 
                      select(-gameplayId,-uId),
                    bordered = TRUE,
                    
                    columns = list(
                      `ep_tackle_def2-11` = colDef(
                        name = "EP Tackle",
                        format = colFormat(digits = 3), 
                      ),
                      avg_yg = colDef(
                        name = "AVG Yards Gained",
                        format = colFormat(digits = 3), 
                      ),
                      tackle_yardline = colDef(
                        name = "Tackle Yardline",
                        format = colFormat(digits = 2), 
                      ),
                      yardline_pred = colDef(
                        name = "Predicted Yardline (from avg)",
                        format = colFormat(digits = 2), 
                      ),
                      yardline_100 = colDef(
                        name = "Line of scrimmage (yardline from endzone)", 
                      ),
                      playResult = colDef(
                        name = "Real Yards Gained (from pbp)"
                      ),
                      true_yardline = colDef(
                        name = "Real EOP yardline (from pbp)" 
                      )
                    )
)

ht_tbl

```

### Tackle gains

```{r tackle_values, echo = FALSE}

tv_tbl <- reactable(tackle_vals %>% 
                      select(-gameplayId) %>%
                      select(gameId,playId,tackler_id,
                             `ep_tackle_def2-11`,`ep_tackle_def1-10`,ep_tackle_real_eop,
                             gain,gain2),
                    bordered = TRUE,
                    
                    columns = list(
                      `ep_tackle_def2-11` = colDef(
                        name = "EP tackle hypothetical frame",
                        format = colFormat(digits = 3), 
                      ),
                      `ep_tackle_def1-10` = colDef(
                        name = "EP tackle real frame",
                        format = colFormat(digits = 3), 
                      ),
                      ep_tackle_real_eop = colDef(
                        name = "EP real EOP yardline",
                        format = colFormat(digits = 3), 
                      ),
                      gain = colDef(
                        name = "EP hypothetical - EP real (Gain)",
                        format = colFormat(digits = 3),
                        style = function(value) {
                          if (value > 0) {
                            color <- "#008000"
                          } else if (value < 0) {
                            color <- "#e00000"
                          } else {
                            color <- "#777"
                          }
                          list(background = color, fontWeight = "bold")
                        }
                        
                      ),
                      gain2 = colDef(
                        name = "EP hypothetical - EP EOP (Gain 2)",
                        format = colFormat(digits = 3),
                        style = function(value) {
                          if (value > 0) {
                            color <- "#008000"
                          } else if (value < 0) {
                            color <- "#e00000"
                          } else {
                            color <- "#777"
                          }
                          list(background = color, fontWeight = "bold")
                        }
                      )
                    )
)

tv_tbl

```


## Possible issues {.tabset}

### Gain analyses

gain and gain2 significantly positive (intuitively this should be the case)


```{r gains_t}

t.test(tackle_vals$`ep_tackle_def2-11`,tackle_vals$`ep_tackle_def1-10`,paired = TRUE)

t.test(tackle_vals$`ep_tackle_def2-11`,tackle_vals$ep_tackle_real_eop,paired = TRUE)

```

```{r gains_plots, fig.height=8, fig.width= 12, echo = FALSE}

par(mfrow = c(2,2))

hist(tackle_vals$gain, main = "Histogram of EP hypothetical - EP real (Gain)", xlab = "gain")
hist(tackle_vals$gain2, main = "Histogram of EP hypothetical - EP EOP (Gain 2)", xlab = "gain2")

boxplot(tackle_vals$gain, main = "Boxplot of EP hypothetical - EP real (Gain)",horizontal = TRUE)
boxplot(tackle_vals$gain2, main = "Boxplot of EP hypothetical - EP EOP (Gain 2)",horizontal = TRUE)

```


### Yardlines analyses {.tabset}

#### Tackle yardlines vs true EOP yardlines (from pbp data). 

I thought they should be quite similar...

```{r eop_yardline}

yardline_diff <- tackle_info_real2$tackle_yardline-tackle_info_real2$true_yardline

summary(yardline_diff)

```

```{r eop_yardline_plots, fig.height=6, fig.width= 12, echo = FALSE}

par(mfrow = c(1,2))
boxplot(yardline_diff)
hist(yardline_diff,main = "")

```

#### **Examples of what may happen:**

  - **gameplayId = 2022092500586:** here apparently tackle led to fumble which was recovered for a TD from the defense (i.e. in this case tackle was very good)
  
```{r ex1_yd, fig.height=6, fig.width= 12, echo = FALSE}

pbp_data_bdb %>% filter(uId == "2022092500_586") %>% select(playDescription,playResult)

tackle_vals %>% filter(gameplayId == 2022092500586)

```
  
  - **gameplayId = 2022091101382:** here penalty on the play (offensive holding -> -10 yards; i.e. tackle was not really necessary) 
  
```{r ex2_yd, fig.height=8, fig.width= 12, echo = FALSE}

pbp_data_bdb %>% filter(uId == "2022091101_382") %>% select(playDescription,playResult)

tackle_vals %>% filter(gameplayId == 2022091101382)

```

  - **gameplayId = 20220925061332:** here again penalty on the play (defensive unnecessary roughness -> -15 yards; i.e. tackle was still necessary, but gain2 is just wrong)
  
```{r ex3_yd, fig.height=8, fig.width= 12, echo = FALSE}

pbp_data_bdb %>% filter(uId == "2022092506_1332") %>% select(playDescription,prePenaltyPlayResult,playResult)

tackle_vals %>% filter(gameplayId == 20220925061332)

```


#### Eliminate penalty play

This may help

```{r el_pens, fig.height=6, fig.width= 12, echo = FALSE,message=FALSE,warning=FALSE}
tackle_info_real2.5 <- tackle_info_real2 %>% 
  left_join(pbp_data_bdb %>% select(uId,penaltyYards,playResult)) %>% 
  filter(is.na(penaltyYards))

yardline_diff2 <- tackle_info_real2.5$tackle_yardline-tackle_info_real2.5$true_yardline

par(mfrow = c(1,2))
boxplot(yardline_diff, main = "with penalty plays", ylim = c(-70,30))
boxplot(yardline_diff2, main = "penalty plays eliminated", ylim = c(-70,30))

```

Still a lot of negative yardline differences: First inspections show that most of them are due to fumbles with recoveries of the defense (here EP model is wrong and thus gain 2 not accurate)

More problematic: positive yardline difference! **Not yet sure what happens here** (example play: uId == "2022091809_369", see also weird looking play2 below)

### Issues with some plays

```{r issue_tab, fig.height=8, fig.width= 12, echo = FALSE}

issue_plays <- tackle_vals %>% filter(gain < -1)

issue_plays

```

Something goes wrong when predicting "real" tackle frame? 

```{r issue_info, fig.height=8, fig.width= 12, echo = FALSE}

tackle_info_real2 %>% filter(gameplayId %in% issue_plays$gameplayId)

```

No Problem when predicting hypothetical tackle frame:

```{r issue_info2, fig.height=8, fig.width= 12, echo = FALSE}

tackle_info_simple2 %>% filter(gameplayId %in% issue_plays$gameplayId)

```


## Example plays {.tabset}

Plot description:

  - Similar to plot by Ole.
  - purple dotted line: Line of scrimmage
  - darkgreen dotted line: real EOP yardline
  - solid black (chartreuse) line: estimated average EOP yardline
  - **upper panel:** Real tackle frame with def 1-10
  - **lower panel:** Hypothetical tackle frame with def 2-11

### Good looking play



```{r play1, fig.height=10, fig.width= 14, echo = FALSE}

gpId <- 20221006001726

vis_tackle_plays(gpId)

```


### Weird looking play

Tackle at yardline around 38 but EOP yardline and (avg) predicted EOP at around 31?

```{r play2, fig.height=10, fig.width= 14, echo = FALSE}

gpId <- 2022091807191

vis_tackle_plays(gpId)
```

### Weird looking play2

What is happening here? Tackle at yardline 80, EOP yardline at 64, prediction with real frame 63.89, prediction with hypothetical frame 70.89???

```{r play2.5, fig.height=10, fig.width= 14, echo = FALSE}

gpId <- 2022091809369

vis_tackle_plays(gpId)
```

### Play from above with high (positive) yardline difference

```{r play3, fig.height=10, fig.width= 14, echo = FALSE}

gpId <- 20220925061332

vis_tackle_plays(gpId)
```

## Visualisations new {.tabset}

**Welche Plot Variante bevorzugt ihr?** :-) 

*Anmerkung: ein paar Kleinigkeiten (e.g. Beschriftung) muss noch angepasst werden.*

### Variante 1 

```{r plot_new1, fig.height=8, fig.width= 14, echo = FALSE}

vis_tackle_plays <- function(gpId){
  tackle_frame <- tackles %>% filter(gameplayId == gpId)
  tackle_info <- tackle_info_real2 %>% filter(gameplayId == gpId)
  pred_r <- tackle_pred_real[which(tackle_info_real2$gameplayId == gpId),]
  pred_s <- tackle_pred_s[which(tackle_info_simple2$gameplayId == gpId),]
  
  par(mfrow = c(2,2), mar = c(4, 4, 0.5, 2) + 0.1)
  
  ########################
  ### real play and pred
  
  plot(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = "blue", xlim = c(0,min(round(max(tackle_frame$x_bc),-1)+30,100)), ylim = c(-53.3/2, 53.3/2), xlab = "x", ylab = "y")
  segments(x0 = 1:20 *5,
           y0 = 53.3/2,
           x1 = 1:20 *5,
           y1 = -53.3/2,
           col = "lightgray", lwd = 0.5)
  segments(x0 = c(0,0),
           y0 = c(53.3/2,-53.3/2),
           x1 = c(100,100),
           y1 = c(53.3/2,-53.3/2),
           lwd = 1.5)
  
  segments(x0 = tackle_info$yardline_100,
           y0 = 53.3/2,
           x1 = tackle_info$yardline_100,
           y1 = -53.3/2,
           col = "purple",lty = 2)
  #abline(v = tackle_info$yardline_100, col = "purple",lty = 2) # line of scrimmage
  
  segments(x0 = 0,
           y0 = 53.3/2,
           x1 = 0,
           y1 = -53.3/2,
           lwd = 1.5)
  #abline(v = 0, lwd = 1.5) # endzone
  
  segments(x0 = tackle_info$true_yardline,
           y0 = 53.3/2,
           x1 = tackle_info$true_yardline,
           y1 = -53.3/2,
           col = "darkgreen",lty = 2)
  
  # plot predicted yard end yard line
  for(j in 1:1000){
    segments(x0 = tackle_frame$x_bc-pred_r[j],
             y0 = 53.3/2,
             x1 = tackle_frame$x_bc-pred_r[j],
             y1 = -53.3/2,
             lwd = 2, col = alpha("chartreuse1", 0.01))
    #abline(v = tackle_frame$x_bc-pred_r[j], lwd = 2, col = alpha("chartreuse1", 0.01))
  }
  segments(x0 = tackle_frame$x_bc - mean(pred_r),
           y0 = 53.3/2,
           x1 = tackle_frame$x_bc - mean(pred_r),
           y1 = -53.3/2,
           col = 1, lwd = 2)
  #abline(v = tackle_frame$x_bc - mean(pred_r), col = 1, lwd = 2) # expected eop yardline
  segments(x0 = tackle_frame$x_bc - mean(pred_r),
           y0 = 53.3/2,
           x1 = tackle_frame$x_bc - mean(pred_r),
           y1 = -53.3/2,
           col = "chartreuse1", lwd = 1)
  #abline(v = tackle_frame$x_bc - mean(pred_r), col = "chartreuse1", lwd = 1) # expected eop yardline
  
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = "blue")
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 16, col = "blue")
  
  for(j in 2:11){
    points(tackle_frame[,paste0("x_or_off", j)], tackle_frame[, paste0("y_or_off", j)], pch = 20, col = "blue")
  }
  for(j in 1:10){
    points(tackle_frame[,paste0("x_or_def", j)], tackle_frame[, paste0("y_or_def", j)], pch = 20, col = "red")
  }
  #points(trackingsub$x_football[i], trackingsub$y_football[i], pch = 9, col = "coral1", lwd = 2)
  
  plot(density(tackle_frame$x_bc-pred_r, bw = 2.5), col = "chartreuse1", lwd = 2, xlim = c(0,min(round(max(tackle_frame$x_bc),-1)+30,100)), bty = "n", main = "", xlab = "eop yardline")
  abline(v = 1:20 *5, col = "lightgray", lwd = 0.5)
  abline(v = tackle_info$yardline_100, col = "purple",lty = 2)
  abline(v = 0, lwd = 1.5) # endzone
  abline(v = tackle_frame$x_bc - mean(pred_r), col = 1, lwd = 2)
  abline(v = tackle_frame$x_bc - mean(pred_r), col = "chartreuse1", lwd = 1)
  abline(v = tackle_info$true_yardline, col = "darkgreen",lty = 2)
  
  ########################
  ### hypothetical play and pred (without closest def)
  
  plot(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = "blue", xlim = c(0,min(round(max(tackle_frame$x_bc),-1)+30,100)), ylim = c(-53.3/2, 53.3/2), xlab = "x", ylab = "y")
  segments(x0 = 1:20 *5,
           y0 = 53.3/2,
           x1 = 1:20 *5,
           y1 = -53.3/2,
           col = "lightgray", lwd = 0.5)
  segments(x0 = c(0,0),
           y0 = c(53.3/2,-53.3/2),
           x1 = c(100,100),
           y1 = c(53.3/2,-53.3/2),
           lwd = 1.5)
  
  segments(x0 = tackle_info$yardline_100,
           y0 = 53.3/2,
           x1 = tackle_info$yardline_100,
           y1 = -53.3/2,
           col = "purple",lty = 2)
  #abline(v = tackle_info$yardline_100, col = "purple",lty = 2) # line of scrimmage
  
  segments(x0 = 0,
           y0 = 53.3/2,
           x1 = 0,
           y1 = -53.3/2,
           lwd = 1.5)
  #abline(v = 0, lwd = 1.5) # endzone
  
  segments(x0 = tackle_info$true_yardline,
           y0 = 53.3/2,
           x1 = tackle_info$true_yardline,
           y1 = -53.3/2,
           col = "darkgreen",lty = 2)
  
  # plot predicted yard end yard line
  for(j in 1:1000){
    segments(x0 = tackle_frame$x_bc-pred_s[j],
             y0 = 53.3/2,
             x1 = tackle_frame$x_bc-pred_s[j],
             y1 = -53.3/2,
             lwd = 2, col = alpha("chartreuse1", 0.01))
    #abline(v = tackle_frame$x_bc-pred_s[j], lwd = 2, col = alpha("chartreuse1", 0.01))
  }
  segments(x0 = tackle_frame$x_bc - mean(pred_s),
           y0 = 53.3/2,
           x1 = tackle_frame$x_bc - mean(pred_s),
           y1 = -53.3/2,
           col = 1, lwd = 2)
  #abline(v = tackle_frame$x_bc - mean(pred_s), col = 1, lwd = 2) # expected eop yardline
  segments(x0 = tackle_frame$x_bc - mean(pred_s),
           y0 = 53.3/2,
           x1 = tackle_frame$x_bc - mean(pred_s),
           y1 = -53.3/2,
           col = "chartreuse1", lwd = 1)
  #abline(v = tackle_frame$x_bc - mean(pred_s), col = "chartreuse1", lwd = 1) # expected eop yardline
  
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = "blue")
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 16, col = "blue")
  
  for(j in 2:11){
    points(tackle_frame[,paste0("x_or_off", j)], tackle_frame[, paste0("y_or_off", j)], pch = 20, col = "blue")
  }
  for(j in 1:10){
    points(tackle_frame[,paste0("x_or_def", j+1)], tackle_frame[, paste0("y_or_def", j+1)], pch = 20, col = "red")
  }
  #points(trackingsub$x_football[i], trackingsub$y_football[i], pch = 9, col = "coral1", lwd = 2)
  
  plot(density(tackle_frame$x_bc-pred_s, bw = 2.5), col = "chartreuse1", lwd = 2, xlim = c(0,min(round(max(tackle_frame$x_bc),-1)+30,100)), bty = "n", main = "", xlab = "eop yardline")
  abline(v = 1:20 *5, col = "lightgray", lwd = 0.5)
  abline(v = tackle_info$yardline_100, col = "purple",lty = 2)
  abline(v = 0, lwd = 1.5) # endzone
  abline(v = tackle_frame$x_bc - mean(pred_s), col = 1, lwd = 2)
  abline(v = tackle_frame$x_bc - mean(pred_s), col = "chartreuse1", lwd = 1)
  abline(v = tackle_info$true_yardline, col = "darkgreen",lty = 2)
  
}

gpId <- 20221006001726

vis_tackle_plays(gpId)
```


### Variante 2 

```{r plot_new2, fig.height=8, fig.width= 14, echo = FALSE}

vis_tackle_plays2 <- function(gpId){
  tackle_frame <- tackles %>% filter(gameplayId == gpId)
  tackle_info <- tackle_info_real2 %>% filter(gameplayId == gpId)
  pred_r <- tackle_pred_real[which(tackle_info_real2$gameplayId == gpId),]
  pred_s <- tackle_pred_s[which(tackle_info_simple2$gameplayId == gpId),]
  
  par(mfrow = c(1,2), mar = c(4, 4, 0.5, 2) + 0.1)
  
  ########################
  ### real play and pred
  
  twoord.plot(lx = tackle_frame$x_bc, ly = tackle_frame$y_bc,
              rx = density(tackle_frame$x_bc-pred_r, bw = 2.5)$x,ry = density(tackle_frame$x_bc-pred_r, bw = 2.5)$y,
              lylim = c(-(53.3/2*3)-5,53.3/2+5),
              rylim = c(-max(density(tackle_frame$x_bc-pred_r, bw = 2.5)$y)/10,
                        max(density(tackle_frame$x_bc-pred_r, bw = 2.5)$y)*2+ max(density(tackle_frame$x_bc-pred_r, bw = 2.5)$y)/5),
              xlim = c(0,min(round(max(tackle_frame$x_bc),-1)+30,100)),
              lytickpos = seq(-20,20,by = 10),
              rytickpos = round(seq(0,max(density(tackle_frame$x_bc-pred_r, bw = 2.5)$y),length.out = 5),3),
              lcol = "blue",rcol = "chartreuse",type = "l", bty = "n",
              axislab.cex = 0.7, main = "Real tackle frame predictions",
              do.first = "abline(h = -(53.3/2*3),col = \"lightgrey\")")
  
  
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = "blue")
  segments(x0 = 1:20 *5,
          y0 = 53.3/2,
          x1 = 1:20 *5,
          y1 = -53.3/2,
          col = "lightgray", lwd = 0.5)
  segments(x0 = c(0,0),
          y0 = c(53.3/2,-53.3/2),
          x1 = c(100,100),
          y1 = c(53.3/2,-53.3/2),
          lwd = 1.5)
  
  segments(x0 = tackle_info$yardline_100,
           y0 = 53.3/2,
           x1 = tackle_info$yardline_100,
           y1 = -53.3/2,
           col = "purple",lty = 2)
  #abline(v = tackle_info$yardline_100, col = "purple",lty = 2) # line of scrimmage
  
  segments(x0 = 0,
           y0 = 53.3/2,
           x1 = 0,
           y1 = -53.3/2,
           lwd = 1.5)
  #abline(v = 0, lwd = 1.5) # endzone
  
  segments(x0 = tackle_info$true_yardline,
           y0 = 53.3/2,
           x1 = tackle_info$true_yardline,
           y1 = -53.3/2,
           col = "darkgreen",lty = 2)
  #abline(v = tackle_info$true_yardline, col = "darkgreen",lty = 2) # true eop yardline
  
  # plot predicted yard end yard line
  for(j in 1:1000){
    segments(x0 = tackle_frame$x_bc-pred_r[j],
             y0 = 53.3/2,
             x1 = tackle_frame$x_bc-pred_r[j],
             y1 = -53.3/2,
             lwd = 2, col = alpha("chartreuse1", 0.01))
    #abline(v = tackle_frame$x_bc-pred_r[j], lwd = 2, col = alpha("chartreuse1", 0.01))
  }
  segments(x0 = tackle_frame$x_bc - mean(pred_r),
           y0 = 53.3/2,
           x1 = tackle_frame$x_bc - mean(pred_r),
           y1 = -53.3/2,
           col = 1, lwd = 2)
  #abline(v = tackle_frame$x_bc - mean(pred_r), col = 1, lwd = 2) # expected eop yardline
  segments(x0 = tackle_frame$x_bc - mean(pred_r),
           y0 = 53.3/2,
           x1 = tackle_frame$x_bc - mean(pred_r),
           y1 = -53.3/2,
           col = "chartreuse1", lwd = 1)
  #abline(v = tackle_frame$x_bc - mean(pred_r), col = "chartreuse1", lwd = 1) # expected eop yardline
  
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = "blue")
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 16, col = "blue")
  
  for(j in 2:11){
    points(tackle_frame[,paste0("x_or_off", j)], tackle_frame[, paste0("y_or_off", j)], pch = 20, col = "blue")
  }
  for(j in 1:10){
    points(tackle_frame[,paste0("x_or_def", j)], tackle_frame[, paste0("y_or_def", j)], pch = 20, col = "red")
  }
  #points(trackingsub$x_football[i], trackingsub$y_football[i], pch = 9, col = "coral1", lwd = 2)
  
  segments(x0 = 1:20 *5,
           y0 = -(53.3/2*3),
           x1 = 1:20 *5,
           y1 = -53.3/2-2,
           col = "lightgray", lwd = 0.5)
  
  segments(x0 = tackle_info$yardline_100,
           y0 = -(53.3/2*3),
           x1 = tackle_info$yardline_100,
           y1 = -53.3/2-2,
           col = "purple",lty = 2)
  
  segments(x0 = 0,
           y0 = -(53.3/2*3),
           x1 = 0,
           y1 = -53.3/2-4,
           lwd = 1.5)
  #abline(v = 0, lwd = 1.5) # endzone
  
  segments(x0 = tackle_frame$x_bc - mean(pred_r),
           y0 = -(53.3/2*3),
           x1 = tackle_frame$x_bc - mean(pred_r),
           y1 = -53.3/2-4,
           col = 1, lwd = 2)
  #abline(v = tackle_frame$x_bc - mean(pred_r), col = 1, lwd = 2) # expected eop yardline
  segments(x0 = tackle_frame$x_bc - mean(pred_r),
           y0 = -(53.3/2*3),
           x1 = tackle_frame$x_bc - mean(pred_r),
           y1 = -53.3/2-4,
           col = "chartreuse1", lwd = 1)
  
  segments(x0 = tackle_info$true_yardline,
           y0 = -(53.3/2*3),
           x1 = tackle_info$true_yardline,
           y1 = -53.3/2-2,
           col = "darkgreen",lty = 2)
  
  ########################
  ### hypothetical play and pred (without closest def)
  
  twoord.plot(lx = tackle_frame$x_bc, ly = tackle_frame$y_bc,
              rx = density(tackle_frame$x_bc-pred_s, bw = 2.5)$x,ry = density(tackle_frame$x_bc-pred_s, bw = 2.5)$y,
              lylim = c(-(53.3/2*3)-5,53.3/2+5),
              rylim = c(-max(density(tackle_frame$x_bc-pred_s, bw = 2.5)$y)/10,
                        max(density(tackle_frame$x_bc-pred_s, bw = 2.5)$y)*2+ max(density(tackle_frame$x_bc-pred_s, bw = 2.5)$y)/5),
              xlim = c(0,min(round(max(tackle_frame$x_bc),-1)+30,100)),
              lytickpos = seq(-20,20,by = 10),
              rytickpos = round(seq(0,max(density(tackle_frame$x_bc-pred_s, bw = 2.5)$y),length.out = 5),3),
              lcol = "blue",rcol = "chartreuse",type = "l", bty = "n",
              axislab.cex = 0.7, main = "Hypothetical tackle frame predictions",
              do.first = "abline(h = -(53.3/2*3),col = \"lightgrey\")")
  
  segments(x0 = 1:20 *5,
           y0 = 53.3/2,
           x1 = 1:20 *5,
           y1 = -53.3/2,
           col = "lightgray", lwd = 0.5)
  segments(x0 = c(0,0),
           y0 = c(53.3/2,-53.3/2),
           x1 = c(100,100),
           y1 = c(53.3/2,-53.3/2),
           lwd = 1.5)
  
  segments(x0 = tackle_info$yardline_100,
           y0 = 53.3/2,
           x1 = tackle_info$yardline_100,
           y1 = -53.3/2,
           col = "purple",lty = 2)
  #abline(v = tackle_info$yardline_100, col = "purple",lty = 2) # line of scrimmage
  
  segments(x0 = 0,
           y0 = 53.3/2,
           x1 = 0,
           y1 = -53.3/2,
           lwd = 1.5)
  #abline(v = 0, lwd = 1.5) # endzone
  
  segments(x0 = tackle_info$true_yardline,
           y0 = 53.3/2,
           x1 = tackle_info$true_yardline,
           y1 = -53.3/2,
           col = "darkgreen",lty = 2)
  #abline(v = tackle_info$true_yardline, col = "darkgreen",lty = 2) # true eop yardline
  
  # plot predicted yard end yard line
  for(j in 1:1000){
    segments(x0 = tackle_frame$x_bc-pred_s[j],
             y0 = 53.3/2,
             x1 = tackle_frame$x_bc-pred_s[j],
             y1 = -53.3/2,
             lwd = 2, col = alpha("chartreuse1", 0.01))
    #abline(v = tackle_frame$x_bc-pred_s[j], lwd = 2, col = alpha("chartreuse1", 0.01))
  }
  segments(x0 = tackle_frame$x_bc - mean(pred_s),
           y0 = 53.3/2,
           x1 = tackle_frame$x_bc - mean(pred_s),
           y1 = -53.3/2,
           col = 1, lwd = 2)
  #abline(v = tackle_frame$x_bc - mean(pred_s), col = 1, lwd = 2) # expected eop yardline
  segments(x0 = tackle_frame$x_bc - mean(pred_s),
           y0 = 53.3/2,
           x1 = tackle_frame$x_bc - mean(pred_s),
           y1 = -53.3/2,
           col = "chartreuse1", lwd = 1)
  #abline(v = tackle_frame$x_bc - mean(pred_s), col = "chartreuse1", lwd = 1) # expected eop yardline
  
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 1, lwd = 6, col = "blue")
  points(tackle_frame$x_bc, tackle_frame$y_bc, pch = 16, col = "blue")
  
  for(j in 2:11){
    points(tackle_frame[,paste0("x_or_off", j)], tackle_frame[, paste0("y_or_off", j)], pch = 20, col = "blue")
  }
  for(j in 1:10){
    points(tackle_frame[,paste0("x_or_def", j+1)], tackle_frame[, paste0("y_or_def", j+1)], pch = 20, col = "red")
  }
  #points(trackingsub$x_football[i], trackingsub$y_football[i], pch = 9, col = "coral1", lwd = 2)
  
  segments(x0 = 1:20 *5,
           y0 = -(53.3/2*3),
           x1 = 1:20 *5,
           y1 = -53.3/2-2,
           col = "lightgray", lwd = 0.5)
  
  segments(x0 = tackle_info$yardline_100,
           y0 = -(53.3/2*3),
           x1 = tackle_info$yardline_100,
           y1 = -53.3/2-2,
           col = "purple",lty = 2)
  
  segments(x0 = 0,
           y0 = -(53.3/2*3),
           x1 = 0,
           y1 = -53.3/2-4,
           lwd = 1.5)
  #abline(v = 0, lwd = 1.5) # endzone
  
  segments(x0 = tackle_frame$x_bc - mean(pred_s),
           y0 = 53.3/2,
           x1 = tackle_frame$x_bc - mean(pred_s),
           y1 = -53.3/2,
           col = 1, lwd = 2)
  #abline(v = tackle_frame$x_bc - mean(pred_r), col = 1, lwd = 2) # expected eop yardline
  segments(x0 = tackle_frame$x_bc - mean(pred_s),
           y0 = 53.3/2,
           x1 = tackle_frame$x_bc - mean(pred_s),
           y1 = -53.3/2,
           col = "chartreuse1", lwd = 1)
  
  segments(x0 = tackle_info$true_yardline,
           y0 = -(53.3/2*3),
           x1 = tackle_info$true_yardline,
           y1 = -53.3/2-2,
           col = "darkgreen",lty = 2)
  
}

gpId <- 20221006001726

vis_tackle_plays2(gpId)
```

## Use case: analyse players {.tabset}


### Top tackles by players

```{r players, echo = FALSE, warning=FALSE, message=FALSE}

make_pal <- function(value,col_low = "darkred",col_high = "darkgreen",nq = 10){
  colourer <- col_quantile(
    palette = c(col_low,col_high),
    domain = c(min(value), max(value)),
    n = nq)
  rev(names(table(colourer(value))))
}

data <- best_tacklers %>% select(tackler_id,displayName,club,url,position,n_tackles,
                           sum_tackle_gains,sum_tackle_gains2,
                           avg_per_tackle,avg_per_tackle2)

crosstalk_data <- SharedData$new(data)

#url.logo <- getURL("https://raw.githubusercontent.com/statsbylopez/BlogPosts/master/nfl_teamlogos.csv")
#df.logos <- read.csv(text = url.logo)

#best_tacklers <- best_tacklers %>%
#  left_join(df.logos , by = c("club" = "team_code"))


position_filter <- filter_checkbox(
  id = "pos",
  label = "Position",
  sharedData = crosstalk_data,
  group = ~ position,
  inline = TRUE
)

n_tackles_filter <- filter_slider(
  id = "n_tackles",
  label = "Number of tackles",
  sharedData = crosstalk_data,
  column = ~ n_tackles,
  ticks = TRUE,
  dragRange = FALSE,
  step = 1,
  width = "50%"
)

tbl <- reactable(crosstalk_data,
  bordered = TRUE,
  defaultSorted = "sum_tackle_gains",
  defaultSortOrder = "desc",
  
  columns = list(
    tackler_id = colDef(
      name = "Tackler ID"
    ),
    displayName = colDef(
      name = "Name"
    ),
    club = colDef(
      name = "Team"
    ),
    url = colDef(
      name = "Team Logo",
      maxWidth = 70,
      align = "center",
      cell = embed_img(height = 25, width = 40)
    ),
    position = colDef(
      name = "Position"
    ),
    n_tackles = colDef(
      name = "# Tackles",
      maxWidth = 50
    ),
    sum_tackle_gains = colDef(
      name = "Gain",
      format = colFormat(digits = 2),
      style = color_scales(best_tacklers, colors = make_pal(best_tacklers$sum_tackle_gains)),
      maxWidth = 70
    ),
    sum_tackle_gains2 = colDef(
      name = "Gain2",
      format = colFormat(digits = 2),
      style = color_scales(best_tacklers, colors = make_pal(best_tacklers$sum_tackle_gains2)),
      maxWidth = 70
    ),
    avg_per_tackle = colDef(
      name = "Avg Gain/Tackle",
      format = colFormat(digits = 2),
      style = color_scales(best_tacklers, colors = make_pal(best_tacklers$avg_per_tackle)),
      maxWidth = 70
    ),
    avg_per_tackle2 = colDef(
      name = "Avg Gain2/Tackle",
      format = colFormat(digits = 2),
      style = color_scales(best_tacklers, colors = make_pal(best_tacklers$avg_per_tackle2)),
      maxWidth = 70
    )
  )
  
)

div(bscols(
  widths = c(4, NA),
    list(position_filter,
         n_tackles_filter))
)

### display table
div(tbl)

```

### Gains per position

```{r pos, fig.height=8, fig.width= 12, echo = FALSE}

pos_df <- best_tacklers %>% 
  group_by(position) %>% 
  summarise(avg = mean(sum_tackle_gains),
            avg2 = mean(sum_tackle_gains2),
            avg_n_tackles = mean(n_tackles),
            n_players = n()) %>% 
  arrange(desc(avg))

reactable(pos_df,
          bordered = TRUE,
          
          columns = list(
            avg = colDef(
              name = "Avg gains per position",
              format = colFormat(digits = 2)
            ),
            avg2 = colDef(
              name = "Avg gains2 per position",
              format = colFormat(digits = 2)
            ),
            avg_n_tackles = colDef(
              name = "Avg # of tackles",
              format = colFormat(digits = 2)
            ),
            n_players = colDef(
              name = "# of Players"
            )
          )
)

```